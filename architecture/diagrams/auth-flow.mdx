---
title: Auth Flow Diagrams
description: Authentication and authorization sequence diagrams
---

Detailed sequence diagrams showing authentication flows, token management, and session handling.

## Email/Password Signup Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB
    participant Email as Brevo Email

    U->>FE: Enter email
    FE->>API: POST /auth/signup
    API->>DB: Check email exists

    alt Email already exists
        DB-->>API: User found
        API-->>FE: 409 Conflict
        FE-->>U: Show "email exists" error
    else Email available
        DB-->>API: No user found
        API->>DB: Create user (PENDING_VERIFICATION)
        API->>DB: Create email_verification record
        API->>Email: Send OTP email
        API->>DB: Create ONBOARDING session
        API-->>FE: 201 + tokens + onboardingStep
        FE->>FE: Store access token (memory)
        FE->>FE: Store refresh token (httpOnly cookie)
        FE-->>U: Redirect to /onboarding
    end
```

## Email Verification Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    U->>FE: Enter OTP from email
    FE->>API: POST /onboarding/verify-email
    Note over FE,API: Authorization: Bearer {onboardingToken}

    API->>DB: Find email_verification
    API->>API: Verify OTP hash

    alt Invalid OTP
        API->>DB: Increment attempts
        API-->>FE: 400 Invalid OTP
        FE-->>U: Show error, tries remaining
    else Max attempts exceeded
        API->>DB: Delete verification record
        API-->>FE: 429 Too many attempts
        FE-->>U: Request new OTP
    else Valid OTP
        API->>DB: Update user.emailVerified = true
        API->>DB: Update user.onboardingStep = SET_PASSWORD
        API->>DB: Delete email_verification
        API-->>FE: 200 + nextStep: SET_PASSWORD
        FE-->>U: Navigate to password setup
    end
```

## Password Setup Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    U->>FE: Enter password + confirm
    FE->>FE: Client-side validation
    FE->>API: POST /onboarding/set-password
    Note over FE,API: Authorization: Bearer {onboardingToken}

    API->>API: Validate password strength
    API->>API: Hash password (Argon2)
    API->>DB: Update user.passwordHash
    API->>DB: Update user.onboardingStep = MOBILE_VERIFICATION
    API-->>FE: 200 + nextStep: MOBILE_VERIFICATION
    FE-->>U: Navigate to phone verification
```

## Login Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    U->>FE: Enter email + password
    FE->>API: POST /auth/login

    API->>DB: Find user by email

    alt User not found
        API-->>FE: 401 Invalid credentials
    else User found
        API->>API: Verify password (Argon2)

        alt Invalid password
            API-->>FE: 401 Invalid credentials
        else Valid password
            alt MFA enabled
                API->>DB: Create pending MFA session
                API-->>FE: 200 + requiresMfa: true
                FE-->>U: Redirect to MFA verification
            else MFA not enabled
                API->>DB: Create CLOUD session
                API->>API: Generate access + refresh tokens
                API-->>FE: 200 + tokens
                FE->>FE: Store tokens
                FE-->>U: Redirect to dashboard
            end
        end
    end
```

## MFA Verification Flow (TOTP)

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    U->>FE: Enter TOTP code
    FE->>API: POST /mfa/verify-totp
    Note over FE,API: Authorization: Bearer {pendingMfaToken}

    API->>DB: Get user's TOTP secret
    API->>API: Verify TOTP code

    alt Invalid code
        API-->>FE: 401 Invalid code
        FE-->>U: Show error
    else Valid code
        API->>DB: Create CLOUD session
        API->>API: Generate access + refresh tokens
        API-->>FE: 200 + tokens
        FE->>FE: Store tokens
        FE-->>U: Redirect to dashboard
    end
```

## OAuth Flow (Google)

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB
    participant Google as Google OAuth

    U->>FE: Click "Sign in with Google"
    FE->>API: GET /auth/oauth/google/initiate
    API->>DB: Store OAuth state token
    API-->>FE: Redirect URL to Google
    FE->>Google: Redirect to consent screen

    U->>Google: Grant permissions
    Google-->>FE: Redirect to callback with code
    FE->>API: GET /auth/oauth/google/callback?code=xxx

    API->>Google: Exchange code for tokens
    Google-->>API: Access token + user info

    API->>DB: Find user by email

    alt New user
        API->>DB: Create user (ACTIVE)
        API->>DB: Create oauth_provider link
        API->>DB: Create CLOUD session
        API-->>FE: Redirect to dashboard
    else Existing user
        API->>DB: Update/create oauth_provider link

        alt MFA enabled
            API->>DB: Create pending MFA session
            API-->>FE: Redirect to MFA verify
        else No MFA
            API->>DB: Create CLOUD session
            API-->>FE: Redirect to dashboard
        end
    end
```

## Token Refresh Flow

```mermaid
sequenceDiagram
    autonumber
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    Note over FE: Access token expired

    FE->>API: POST /auth/refresh
    Note over FE,API: Cookie: refreshToken=xxx
    Note over FE,API: Authorization: Bearer {expiredAccessToken}

    API->>API: Hash refresh token
    API->>DB: Find session by refresh hash

    alt Session not found
        API-->>FE: 401 Unauthorized
        FE->>FE: Clear tokens
        FE-->>FE: Redirect to login
    else Session found
        API->>API: Verify token binding
        Note over API: Hash(accessToken) == session.refreshTokenBindingHash

        alt Binding mismatch
            API->>DB: Delete session (potential theft)
            API-->>FE: 401 Unauthorized
        else Valid binding
            API->>API: Generate new access token
            API->>API: Generate new refresh token
            API->>DB: Update session tokens
            API-->>FE: 200 + new tokens
            FE->>FE: Store new tokens
            FE->>FE: Retry original request
        end
    end
```

## Logout Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB

    U->>FE: Click logout
    FE->>API: POST /auth/logout
    Note over FE,API: Authorization: Bearer {accessToken}

    API->>API: Hash access token
    API->>DB: Find session by access hash
    API->>DB: Delete session
    API-->>FE: 204 No Content

    FE->>FE: Clear access token (memory)
    FE->>FE: Clear refresh token (cookie)
    FE-->>U: Redirect to login
```

## Passkey Authentication Flow

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant FE as Frontend
    participant API as API Nexus
    participant DB as Primary DB
    participant Auth as WebAuthn Authenticator

    U->>FE: Click "Sign in with Passkey"
    FE->>API: POST /auth/passkey/start
    API->>DB: Find user's passkey credential
    API->>API: Generate WebAuthn challenge
    API-->>FE: Challenge + credential options

    FE->>Auth: navigator.credentials.get()
    Auth->>U: Biometric prompt (Touch ID/Face ID)
    U->>Auth: Authenticate
    Auth-->>FE: Signed assertion

    FE->>API: POST /auth/passkey/verify
    API->>API: Verify WebAuthn signature
    API->>DB: Verify credential ID matches

    alt Verification failed
        API-->>FE: 401 Invalid passkey
    else Verification success
        API->>DB: Create CLOUD session
        API-->>FE: 200 + tokens
        FE-->>U: Redirect to dashboard
    end
```

## CSRF Protection Flow

```mermaid
sequenceDiagram
    autonumber
    participant FE as Frontend
    participant API as API Nexus

    Note over FE,API: Initial page load
    FE->>API: GET /auth/csrf-token
    API->>API: Generate CSRF token
    API-->>FE: Set-Cookie: _csrf={token}
    API-->>FE: 200 { csrfToken: "xxx" }
    FE->>FE: Store token for headers

    Note over FE,API: Subsequent mutation request
    FE->>API: POST /auth/login
    Note over FE,API: Cookie: _csrf={token}
    Note over FE,API: X-CSRF-Token: {token}

    API->>API: Compare cookie vs header

    alt Tokens match
        API->>API: Process request
        API-->>FE: 200 Success
    else Tokens mismatch
        API-->>FE: 403 Invalid CSRF token
    end
```

## Session Types

| Type | Purpose | Duration | Token Binding |
|------|---------|----------|---------------|
| `ONBOARDING` | Signup/onboarding flow | 1 hour | Yes |
| `CLOUD` | Full authenticated access | 15 min (access), 7 days (refresh) | Yes |
| `MFA_PENDING` | Awaiting MFA verification | 5 min | No |

## Security Features

<CardGroup cols={2}>
  <Card title="Token Binding" icon="link">
    Refresh tokens are bound to access tokens via hash. Prevents token theft attacks.
  </Card>
  <Card title="Argon2 Hashing" icon="lock">
    Passwords hashed with Argon2id, the winning algorithm from the Password Hashing Competition.
  </Card>
  <Card title="Short-lived Tokens" icon="clock">
    Access tokens expire in 15 minutes. Refresh tokens enable seamless renewal.
  </Card>
  <Card title="CSRF Protection" icon="shield">
    Double-submit cookie pattern prevents cross-site request forgery.
  </Card>
</CardGroup>

## Next Steps

<CardGroup cols={2}>
  <Card title="System Architecture" icon="sitemap" href="/architecture/diagrams/system-architecture">
    Overall system overview
  </Card>
  <Card title="Data Flow Diagram" icon="arrows-spin" href="/architecture/diagrams/data-flow">
    Request lifecycle visualization
  </Card>
</CardGroup>
