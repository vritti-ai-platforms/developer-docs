---
title: "CSRF Protection"
description: "Cross-Site Request Forgery protection implementation details"
---

## Overview

<Info>
**Implemented by:** Shashank
**Last Updated:** January 2026
**Status:** Production
</Info>

CSRF (Cross-Site Request Forgery) protection prevents unauthorized commands from being transmitted from a user that the web application trusts.

## What It Does

- Generates unique tokens for each user session
- Validates tokens on state-changing requests (POST, PUT, DELETE)
- Rejects requests with missing or invalid tokens
- Protects forms and AJAX requests from cross-site attacks

## Where It's Used

| Location | Purpose |
|----------|---------|
| `src/middleware/csrf.js` | Main CSRF middleware |
| `src/utils/token.js` | Token generation utilities |
| `src/templates/forms.html` | Token injection in forms |

## How It Works

<Steps>
  <Step title="Token Generation">
    When a user starts a session, a unique CSRF token is generated and stored.

    ```javascript
    // src/middleware/csrf.js
    const generateToken = (session) => {
      const token = crypto.randomBytes(32).toString('hex');
      session.csrfToken = token;
      return token;
    };
    ```
  </Step>

  <Step title="Token Injection">
    The token is included in all forms and made available for AJAX requests.

    ```html
    <form method="POST">
      <input type="hidden" name="_csrf" value="{{csrfToken}}">
      <!-- form fields -->
    </form>
    ```
  </Step>

  <Step title="Token Validation">
    On each state-changing request, the middleware validates the token.

    ```javascript
    // src/middleware/csrf.js
    const validateToken = (req, res, next) => {
      const token = req.body._csrf || req.headers['x-csrf-token'];
      if (token !== req.session.csrfToken) {
        return res.status(403).json({ error: 'Invalid CSRF token' });
      }
      next();
    };
    ```
  </Step>
</Steps>

## Configuration

```javascript
// config/security.js
module.exports = {
  csrf: {
    enabled: true,
    cookieName: '_csrf',
    headerName: 'x-csrf-token',
    excludePaths: ['/api/webhooks', '/health']
  }
};
```

## Usage Examples

### In HTML Forms

```html
<form action="/api/update-profile" method="POST">
  <input type="hidden" name="_csrf" value="{{csrfToken}}">
  <input type="text" name="name" placeholder="Your name" />
  <button type="submit">Update Profile</button>
</form>
```

### In AJAX/Fetch Requests

```javascript
// Get token from meta tag
const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

fetch('/api/update-profile', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken
  },
  body: JSON.stringify({ name: 'New Name' })
});
```

## Limitations

<Warning>
**Known Limitations:**
</Warning>

1. **Stateless APIs**: CSRF tokens require session state; not suitable for purely stateless REST APIs that use JWT
2. **Token Expiry**: Tokens don't expire independently of sessions - they live as long as the session
3. **Multi-tab Issues**: Opening multiple tabs may cause token mismatch in edge cases where tokens rotate
4. **Mobile Apps**: Native mobile apps typically use JWT/OAuth instead of CSRF tokens

## Troubleshooting

<Accordion title="403 Forbidden: Invalid CSRF token">
  **Causes:**
  - Token not included in request body or headers
  - Session expired and token invalidated
  - Token mismatch between form and session

  **Solution:**
  1. Ensure the token is present in your form or request headers
  2. Check if the user session is still valid
  3. Refresh the page to get a new token
</Accordion>

<Accordion title="Token not available in template">
  **Cause:** CSRF middleware not applied before the route handler

  **Solution:** Ensure CSRF middleware runs before your routes:
  ```javascript
  // Correct order
  app.use(csrfMiddleware);
  app.use('/api', apiRoutes);
  ```
</Accordion>

<Accordion title="CSRF token missing in AJAX requests">
  **Cause:** Token not being sent in request headers

  **Solution:** Add a meta tag and include it in your fetch calls:
  ```html
  <meta name="csrf-token" content="{{csrfToken}}">
  ```

  ```javascript
  headers: {
    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
  }
  ```
</Accordion>

## Related Concepts

- **Session Management** - CSRF relies on session state
- **JWT Authentication** - Alternative for stateless APIs (no CSRF needed)
- **SameSite Cookies** - Additional browser-level CSRF protection
